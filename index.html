<!DOCTYPE html>
<html>
<head>
    <title>Type here</title>
    <style>
        body { 
            font-family: Arial; 
            max-width: 600px; 
            margin: 50px auto; 
            padding: 20px; 
            background-color: #000000;
            color: #ffffff;
        }

        input { 
            width: 100%; 
            padding: 10px; 
            font-size: 16px; 
            margin-bottom: 5px; 
            box-sizing: border-box; 
            background-color: #000000; 
            color: #ffffff; 
            border: 1px solid #555;
        }

        #wordCounter {
            font-size: 14px;
            margin-bottom: 10px;
            color: #cccccc;
        }

        button { 
            padding: 10px 20px; 
            font-size: 16px; 
            cursor: pointer; 
            background-color: #cc0000; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            transition: 0.2s;
        }

        button:hover { 
            background-color: #8b0000; 
        }

        .pulse {
            animation: pulseAnim 1s infinite ease-in-out;
        }

        @keyframes pulseAnim {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        #cooldown {
            margin-top: 5px;
            font-size: 14px;
            color: #cccccc;
            height: 18px;
        }

        #output { 
            margin-top: 20px; 
            padding: 15px; 
            border: 1px solid #ccc; 
            background: #000000; 
            color: #ffffff; 
            font-size: 18px; 
            word-break: break-all; 
        }
    </style>
</head>
<body>
    <h1>Read Question, Type Answer, Press enter... Wait for Response</h1>

    <input type="text" id="textInput" placeholder="Type something..." value="">
    <div id="wordCounter">Words left: 5</div>

    <button id="convertBtn" onclick="convert()">It listens</button>
    <div id="cooldown"></div>

    <div id="output">output</div>

    <script>
        const morseMap = {
            'A': '.-', 'B': '-...', 'C': '-.-.', 'D': '-..', 'E': '.', 'F': '..-.',
            'G': '--.', 'H': '....', 'I': '..', 'J': '.---', 'K': '-.-', 'L': '.-..',
            'M': '--', 'N': '-.', 'O': '---', 'P': '.--.', 'Q': '--.-', 'R': '.-.',
            'S': '...', 'T': '-', 'U': '..-', 'V': '...-', 'W': '.--', 'X': '-..-',
            'Y': '-.--', 'Z': '--..', '0': '-----', '1': '.----', '2': '..---',
            '3': '...--', '4': '....-', '5': '.....', '6': '-....', '7': '--...',
            '8': '---..', '9': '----.', '.': '.-.-.-', ',': '--..--', '?': '..--..',
            "'": '.----', '!': '-.-.--', '/': '-..-.', '(': '-.--.', ')': '-.--.-',
            '&': '.-...', ':': '---...', ';': '-.-.-.', '=': '-...-', '+': '.-.-.',
            '-': '-....-', '_': '..--.-', '"': '.-..-.', '$': '...-..-', '@': '.--.-.'
        };

        const allowedChars = /^[A-Za-z0-9 .,?'!/()&:;=+\-_"$@]*$/;

        const audioContext = new (window.AudioContext || window.webkitAudioContext)();

        function textToMorse(text) {
            return text.toUpperCase().split('').map(char => {
                if (char === ' ') return ' / ';
                return morseMap[char] || '';
            }).join(' ').replace(/\s+/g, ' ').trim();
        }

        function playMorse(morse) {
            const dotDuration = 0.085;
            const dashDuration = 0.255;
            const gapDuration = 0.085;
            const letterGap = 0.255;
            const wordGap = 0.595;

            let time = audioContext.currentTime;

            startCooldown(time);

            for (let char of morse) {
                if (char === '.') {
                    playTone(time, dotDuration);
                    time += dotDuration + gapDuration;
                } else if (char === '-') {
                    playTone(time, dashDuration);
                    time += dashDuration + gapDuration;
                } else if (char === ' ') {
                    time += letterGap;
                } else if (char === '/') {
                    time += wordGap;
                }
            }

            endCooldownAt(time);
        }

        function playTone(startTime, duration) {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 500;
            oscillator.start(startTime);
            oscillator.stop(startTime + duration);
        }

        let cooldownActive = false;
        let cooldownTimer = null;
        let focusLockTimer = null;

        function startCooldown(startTime) {
            cooldownActive = true;

            const button = document.getElementById("convertBtn");
            const cooldownDiv = document.getElementById("cooldown");
            const input = document.getElementById("textInput");

            button.disabled = true;
            button.classList.add("pulse");
            cooldownDiv.innerText = "Morse playing...";

            input.placeholder = "Now you listen...";
            input.focus();

            focusLockTimer = setInterval(() => {
                if (cooldownActive && document.activeElement !== input) {
                    input.focus();
                }
            }, 100);
        }

        function endCooldownAt(endTime) {
            const button = document.getElementById("convertBtn");
            const cooldownDiv = document.getElementById("cooldown");
            const input = document.getElementById("textInput");

            if (cooldownTimer) clearInterval(cooldownTimer);

            cooldownTimer = setInterval(() => {
                const now = audioContext.currentTime;

                if (now >= endTime) {
                    clearInterval(cooldownTimer);
                    cooldownActive = false;
                    button.disabled = false;
                    button.classList.remove("pulse");
                    cooldownDiv.innerText = "";

                    input.placeholder = "Type something...";

                    clearInterval(focusLockTimer);
                    focusLockTimer = null;
                }
            }, 100);
        }

        function convert() {
            if (cooldownActive) return;

            let text = document.getElementById('textInput').value;

            text = text.replace(/\s+/g, " ").trim();
            text = text.slice(0, 60);

            let words = text.split(" ");
            if (words.length > 5) {
                words = words.slice(0, 5);
                text = words.join(" ");
            }

            if (!text) {
                alert('Please type something!');
                return;
            }

            /* ------------------------------
               SAVE ANSWER TO LOCAL STORAGE
            ------------------------------ */
            let answers = JSON.parse(localStorage.getItem("answers")) || [];
            answers.push({
                text: text,
                timestamp: new Date().toISOString()
            });
            localStorage.setItem("answers", JSON.stringify(answers));
            /* -------------------------------- */

            const morse = textToMorse(text);
            document.getElementById('output').innerHTML = morse;
            playMorse(morse);

            document.getElementById('textInput').value = "";
            wordCounter.innerText = "Words left: 5";
        }

        const textInput = document.getElementById('textInput');
        const wordCounter = document.getElementById('wordCounter');

        textInput.addEventListener('input', function () {

            if (cooldownActive) {
                this.value = "";
                return;
            }

            if (!allowedChars.test(this.value)) {
                this.value = this.value.replace(/[^A-Za-z0-9 .,?'!/()&:;=+\-_"$@]/g, "");
            }

            if (this.value.length > 60) {
                this.value = this.value.slice(0, 60);
            }

            this.value = this.value.replace(/\s+/g, " ");

            const trimmed = this.value.trim();

            if (trimmed === "") {
                wordCounter.innerText = "Words left: 5";
                return;
            }

            let words = trimmed.split(" ");

            if (words.length > 5) {
                words = words.slice(0, 5);
                this.value = words.join(" ");
            }

            const remaining = 5 - words.length;
            wordCounter.innerText = "Words left: " + remaining;
        });

        textInput.addEventListener('keypress', function(e) {
            if (cooldownActive) {
                e.preventDefault();
                return;
            }
            if (e.key === 'Enter' && !cooldownActive) {
                convert();
            }
        });

        /* -----------------------------------------
           HIDDEN ADMIN VIEWER (CTRL + SHIFT + L)
        ----------------------------------------- */
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.shiftKey && e.key === 'L') {
                let answers = JSON.parse(localStorage.getItem("answers")) || [];

                let adminWin = window.open("", "AdminWindow", "width=600,height=400");
                adminWin.document.write(
                    "<pre style='white-space: pre-wrap; font-size: 16px;'>" +
                    JSON.stringify(answers, null, 2) +
                    "</pre>"
                );
            }
        });
        /* ----------------------------------------- */

    </script>
</body>
</html>
